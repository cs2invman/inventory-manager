{#
    Reusable Item Card Component

    Parameters:
    - itemUser: ItemUser entity (required)
    - item: Item entity (optional, defaults to itemUser.item)
    - latestPrice: Latest ItemPrice entity (optional)
    - priceValue: Calculated price value including stickers/keychains (optional)
    - stickersWithPrices: Array of sticker data with prices (optional)
    - keychainWithPrice: Keychain data with price (optional)
    - mode: Display mode - 'display', 'with-checkbox', 'with-storage-badge' (default: 'display')
    - checked: Checkbox state for 'with-checkbox' mode (optional, default: true)
    - itemId: Unique identifier for checkbox (optional)
    - rarity: Item rarity for filtering (optional)
    - type: Item type for filtering (optional)
    - quantity: Quantity of grouped items (optional, default: 1)
    - aggregatePrice: Total price for grouped items (optional, default: priceValue)
    - userConfig: UserConfig entity for currency formatting (optional)

    Blocks:
    - badges: Override/add custom badges
    - actions: Add action buttons
    - checkbox: Override checkbox rendering
#}

{% set item = item|default(itemUser.item) %}
{% set mode = mode|default('display') %}
{% set checked = checked is defined ? checked : true %}
{% set priceValue = priceValue|default(null) %}
{% set latestPrice = latestPrice|default(null) %}

<div class="card hover:border-cs2-orange transition-colors duration-200 group relative"
    {% if mode == 'with-checkbox' %}
        data-rarity="{{ rarity|default(item.rarity) }}"
        data-type="{{ type|default(item.type) }}"
        data-price="{{ priceValue|default(0) }}"
    {% endif %}
>
    {# Checkbox for import preview #}
    {% if mode == 'with-checkbox' %}
        <div class="absolute top-2 right-2 z-10">
            {% block checkbox %}
                <input
                    type="checkbox"
                    name="selected_items[]"
                    value="{{ itemId|default(loop.index) }}"
                    {% if checked %}checked{% endif %}
                    class="h-5 w-5 rounded border-gray-600 bg-gray-700 text-cs2-orange focus:ring-cs2-orange focus:ring-offset-gray-800"
                >
            {% endblock %}
        </div>
    {% endif %}

    {# Custom Badges Block #}
    {% block badges %}{% endblock %}

    {# Quantity Badge for Grouped Items #}
    {% if quantity|default(1) > 1 %}
        <div class="absolute top-2 right-2 z-10">
            <span class="inline-flex items-center justify-center bg-cs2-orange text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg min-w-[3rem]">
                ×{{ quantity }}
            </span>
        </div>
    {% endif %}

    {# Item Name #}
    <h3 class="font-semibold text-white text-sm line-clamp-2 group-hover:text-cs2-orange transition-colors mb-3" title="{{ item.name }}">
        {{ item.name }}
    </h3>

    {# Item Image Container #}
    <div class="relative bg-gray-900 rounded-lg p-4 mb-3 flex items-center justify-center h-48">
        {# Rarity Indicator Line #}
        {% if item.rarityColor %}
            <div class="absolute bottom-0 left-0 right-0 h-1 rounded-b-lg" style="background-color: {{ item.rarityColor }};"></div>
        {% endif %}

        {# Item Image #}
        <img
            src="{{ item.imageUrl }}"
            alt="{{ item.name }}"
            class="max-h-full max-w-full object-contain"
        >

        {# Steam Market Link #}
        <a
            href="https://steamcommunity.com/market/listings/730/{{ item.hashName|url_encode }}"
            target="_blank"
            rel="noopener noreferrer"
            class="absolute top-2 right-2 bg-gray-800 hover:bg-steam-blue p-1.5 rounded transition-colors"
            title="View on Steam Market"
        >
            <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0-3.016-1.173-3.331-2.727L.436 15.27C1.862 20.307 6.486 24 11.979 24c6.627 0 11.999-5.373 11.999-12S18.605 0 11.979 0zM7.54 18.21l-1.473-.61c.262.543.714.999 1.314 1.25 1.297.539 2.793-.076 3.332-1.375.263-.63.264-1.319.005-1.949s-.75-1.121-1.377-1.383c-.624-.26-1.29-.249-1.878-.03l1.523.63c.956.4 1.409 1.5 1.009 2.455-.397.957-1.497 1.41-2.454 1.012H7.54zm11.415-9.303c0-1.662-1.353-3.015-3.015-3.015-1.665 0-3.015 1.353-3.015 3.015 0 1.665 1.35 3.015 3.015 3.015 1.663 0 3.015-1.35 3.015-3.015zm-5.273-.005c0-1.252 1.013-2.266 2.265-2.266 1.249 0 2.266 1.014 2.266 2.266 0 1.251-1.017 2.265-2.266 2.265-1.253 0-2.265-1.014-2.265-2.265z" />
            </svg>
        </a>

        <div class="absolute top-2 left-2 flex flex-wrap gap-1">
            {# Storage Box Badge #}
            {% if mode == 'with-storage-badge' and itemUser.storageBox is not null %}
                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded flex items-center justify-center" title="{{ itemUser.storageBox.name }}">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none">
                        <path d="M7 19V21M17 19V21M17 11C17.5523 11 18 10.5523 18 10C18 9.44772 17.5523 9 17 9C16.4477 9 16 9.44772 16 10C16 10.5523 16.4477 11 17 11ZM17 11V14M17 10H17.01M9.5 11.5H9.51M13 11.5C13 13.433 11.433 15 9.5 15C7.567 15 6 13.433 6 11.5C6 9.567 7.567 8 9.5 8C11.433 8 13 9.567 13 11.5ZM7.8 19H16.2C17.8802 19 18.7202 19 19.362 18.673C19.9265 18.3854 20.3854 17.9265 20.673 17.362C21 16.7202 21 15.8802 21 14.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V14.2C3 15.8802 3 16.7202 3.32698 17.362C3.6146 17.9265 4.07354 18.3854 4.63803 18.673C5.27976 19 6.11984 19 7.8 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </span>
            {% endif %}

            {# StatTrak Badge #}
            {% if itemUser.isStattrak %}
                <span class="bg-cs2-orange text-white text-xs font-bold px-2 py-1 rounded">
                    ST
                </span>
            {% endif %}

            {# Souvenir Badge #}
            {% if itemUser.isSouvenir %}
                <span class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded">
                    SV
                </span>
            {% endif %}
        </div>

        {# Pattern Index for Charm/Keychain Items #}
        {% if itemUser.patternIndex and item.hashName starts with 'Charm |' %}
            <div class="absolute bottom-2 left-2">
                <span class="bg-gray-700 text-white text-xs font-bold px-2 py-1 rounded" title="Pattern Index: {{ itemUser.patternIndex }}">
                    #{{ itemUser.patternIndex }}
                </span>
            </div>
        {% endif %}

        {# Stickers and Keychain Overlay #}
        {% if stickersWithPrices or keychainWithPrice %}
            <div class="absolute bottom-2 left-2 flex gap-1">
                {# Keychain #}
                {% if keychainWithPrice %}
                    <a
                        href="https://steamcommunity.com/market/listings/730/{{ keychainWithPrice.hash_name|url_encode }}"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="hover:opacity-75 transition-opacity"
                        title="Keychain: {{ keychainWithPrice.name }} ({{ keychainWithPrice.price|format_price(userConfig ? userConfig.preferredCurrency : 'USD', userConfig ? userConfig.cadExchangeRate : 1.0) }})"
                    >
                        <img
                            src="{{ keychainWithPrice.image_url }}"
                            alt="{{ keychainWithPrice.name }}"
                            class="h-8 w-10 rounded bg-gray-800/80 p-0.5 border border-yellow-500"
                        >
                    </a>
                {% endif %}

                {# Stickers #}
                {% if stickersWithPrices %}
                    {% for sticker in stickersWithPrices %}
                        <a
                            href="https://steamcommunity.com/market/listings/730/{{ sticker.hash_name|url_encode }}"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="hover:opacity-75 transition-opacity"
                            title="{{ sticker.name }} ({{ sticker.price|format_price(userConfig ? userConfig.preferredCurrency : 'USD', userConfig ? userConfig.cadExchangeRate : 1.0) }})"
                        >
                            <img
                                src="{{ sticker.image_url }}"
                                alt="{{ sticker.name }}"
                                class="h-8 w-10 rounded bg-gray-800/80 p-0.5"
                            >
                        </a>
                    {% endfor %}
                {% endif %}
            </div>
        {% endif %}
    </div>

    {# Item Details #}
    <div class="space-y-2">
        {# Wear/Float and Pattern Row (for non-grouped items) #}
        {% if quantity|default(1) == 1 %}
            <div class="flex items-center justify-between text-xs">
                {# Left: Wear, Float, and Pattern #}
                <div class="flex items-center gap-2">
                    {% if itemUser.wearCategory %}
                        <span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded">{{ itemUser.wearCategory }}</span>
                    {% endif %}
                    {% if itemUser.floatValue %}
                        <span class="text-gray-300 font-mono ml-1">{{ itemUser.floatValue }}</span>
                    {% endif %}
                    {% if itemUser.paintSeed %}
                        <span class="text-gray-300 font-mono ml-1">#{{ itemUser.paintSeed }}</span>
                    {% elseif itemUser.patternIndex %}
                        <span class="text-gray-300 font-mono ml-1">#{{ itemUser.patternIndex }}</span>
                    {% endif %}
                </div>

                {# Right: Price #}
                <span class="text-green-400 font-bold text-lg">
                    {% if latestPrice and priceValue is not null %}
                        {{ priceValue|format_price(
                            userConfig ? userConfig.preferredCurrency : 'USD',
                            userConfig ? userConfig.cadExchangeRate : 1.0
                        ) }}
                    {% else %}
                        <span class="text-gray-500">N/A</span>
                    {% endif %}
                </span>
            </div>
        {% else %}
            {# Grouped items: Show quantity × unit price = aggregate #}
            <div class="flex items-center justify-between text-xs">
                {# Left: Quantity × Unit Price #}
                <div class="flex items-center gap-1 text-gray-300">
                    <span class="font-bold text-white">{{ quantity }}</span>
                    <span>×</span>
                    <span>
                        {% if latestPrice and priceValue is not null %}
                            {{ priceValue|format_price(
                                userConfig ? userConfig.preferredCurrency : 'USD',
                                userConfig ? userConfig.cadExchangeRate : 1.0
                            ) }}
                        {% else %}
                            <span class="text-gray-500">N/A</span>
                        {% endif %}
                    </span>
                </div>

                {# Right: Aggregate Price #}
                <span class="text-green-400 font-bold text-lg">
                    {% if latestPrice and aggregatePrice|default(priceValue) is not null %}
                        {{ aggregatePrice|default(priceValue)|format_price(
                            userConfig ? userConfig.preferredCurrency : 'USD',
                            userConfig ? userConfig.cadExchangeRate : 1.0
                        ) }}
                    {% else %}
                        <span class="text-gray-500">N/A</span>
                    {% endif %}
                </span>
            </div>
        {% endif %}

        {# Name Tag #}
        {% if itemUser.nameTag %}
            <div class="pt-2 border-t border-gray-700">
                <p class="text-xs text-gray-400">Name Tag:</p>
                <p class="text-xs text-yellow-400 italic">"{{ itemUser.nameTag }}"</p>
            </div>
        {% endif %}
    </div>

    {# Custom Actions Block #}
    {% block actions %}{% endblock %}
</div>
