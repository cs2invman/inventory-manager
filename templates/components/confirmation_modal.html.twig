{#
    Reusable Two-Step Confirmation Modal Component

    Parameters:
    - modalId: Unique identifier for the modal (required)
    - title: Modal title text (required)
    - message: Confirmation message shown in step 1 (required)
    - confirmText: The exact text user must type to confirm (required, e.g., "Delete")
    - confirmPrompt: Instructions for step 2 (optional, defaults to "Type {confirmText} to confirm:")
    - actionUrl: Form action URL (required)
    - actionMethod: HTTP method (optional, default: 'POST')
    - cancelText: Text for cancel button (optional, default: 'Cancel')
    - continueText: Text for continue button (optional, default: 'Continue')
    - backText: Text for back button (optional, default: 'Back')
    - confirmButtonText: Text for final confirm button (optional, default: 'Confirm')
    - caseSensitive: Whether confirmText matching is case-sensitive (optional, default: true)

    Usage:
    {% embed 'components/confirmation_modal.html.twig' with {
        modalId: 'deleteModal',
        title: 'Delete All Data?',
        message: 'This will permanently delete all your data.',
        confirmText: 'Delete',
        actionUrl: path('delete_route')
    } %}
        {% block trigger %}
            <button type="button" @click="openModal" class="btn-danger">
                Delete All
            </button>
        {% endblock %}
    {% endembed %}
#}

{% set actionMethod = actionMethod|default('POST') %}
{% set cancelText = cancelText|default('Cancel') %}
{% set continueText = continueText|default('Continue') %}
{% set backText = backText|default('Back') %}
{% set confirmButtonText = confirmButtonText|default('Confirm') %}
{% set caseSensitive = caseSensitive is defined ? caseSensitive : true %}
{% set confirmPrompt = confirmPrompt|default('Type <span class="font-mono font-bold text-red-400">' ~ confirmText ~ '</span> ' ~ (caseSensitive ? '(case-sensitive) ' : '') ~ 'to confirm:') %}

<div
    x-data="{
        showModal: false,
        confirmationStep: 1,
        inputText: '',
        get isTextCorrect() {
            {% if caseSensitive %}
            return this.inputText === '{{ confirmText|e('js') }}';
            {% else %}
            return this.inputText.toLowerCase() === '{{ confirmText|lower|e('js') }}';
            {% endif %}
        },
        openModal() {
            this.showModal = true;
            this.confirmationStep = 1;
            this.inputText = '';
        },
        closeModal() {
            this.showModal = false;
            this.confirmationStep = 1;
            this.inputText = '';
        },
        continueToStep2() {
            this.confirmationStep = 2;
            this.$nextTick(() => {
                this.$refs.confirmInput?.focus();
            });
        },
        goBackToStep1() {
            this.confirmationStep = 1;
            this.inputText = '';
        }
    }"
>
    {# Trigger button/element - can be customized via block #}
    {% block trigger %}
        <button
            type="button"
            @click="openModal"
            class="btn-danger"
        >
            {{ confirmButtonText }}
        </button>
    {% endblock %}

    {# Modal #}
    <div
        x-show="showModal"
        x-cloak
        class="fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="modal-title-{{ modalId }}"
        role="dialog"
        aria-modal="true"
    >
        {# Background overlay #}
        <div
            x-show="showModal"
            x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity"
            @click="closeModal"
        ></div>

        {# Modal panel #}
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                x-show="showModal"
                x-transition:enter="ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                class="relative bg-gray-800 rounded-lg shadow-xl max-w-lg w-full border border-gray-700"
                @click.stop
            >
                {# Step 1: Initial Confirmation #}
                <div x-show="confirmationStep === 1" class="p-6">
                    <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white text-center mb-4" id="modal-title-{{ modalId }}">
                        {{ title }}
                    </h3>
                    <p class="text-gray-300 text-center mb-6">
                        {{ message|raw }}
                    </p>
                    <div class="flex space-x-3">
                        <button
                            type="button"
                            @click="closeModal"
                            class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500"
                        >
                            {{ cancelText }}
                        </button>
                        <button
                            type="button"
                            @click="continueToStep2"
                            class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
                        >
                            {{ continueText }}
                        </button>
                    </div>
                </div>

                {# Step 2: Text Input Confirmation #}
                <div x-show="confirmationStep === 2" class="p-6">
                    <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white text-center mb-4">
                        Final Confirmation
                    </h3>
                    <p class="text-gray-300 text-center mb-4">
                        {{ confirmPrompt|raw }}
                    </p>
                    <form action="{{ actionUrl }}" method="{{ actionMethod }}">
                        <input
                            type="text"
                            x-model="inputText"
                            x-ref="confirmInput"
                            class="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-500 mb-4"
                            placeholder="{{ confirmText }}"
                            autocomplete="off"
                        >
                        <div class="flex space-x-3">
                            <button
                                type="button"
                                @click="goBackToStep1"
                                class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500"
                            >
                                {{ backText }}
                            </button>
                            <button
                                type="submit"
                                :disabled="!isTextCorrect"
                                class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {{ confirmButtonText }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
